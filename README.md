# 🎮 RenpyLens 🔍

RenpyLens 是一款专为 **Ren'Py 引擎游戏** 开发的轻量级、实时游戏翻译弹窗工具。
本软件既**小白友好**（支持一键拖拽翻译），又适合有一定基础的用户上手部署或二次开发。

通过原生的注入方式，在游戏运行期间实时抓取文本，并使用强大的 **AI大语言模型引擎** 将其翻译为您需要的语言，浮窗显示在游戏之上。

## ✨ 核心特性

- **拖拽式一键操作**: 直接将游戏的 `.exe` 文件拖入主界面即可。
- **动态 Hook 注入**: 原生文本提取。通过 Hook 脚本直接桥接 Ren'Py 游戏引擎，实现无损文本提取。
- **多引擎支持 (LLMs)**: 本地和云端大语言模型无缝切换，保证上下文连贯性和角色语气：
  - **内置引擎**: 我们为用户提供的首选专属服务，开箱即用，极简操作免去配置烦恼。
  - **云端大厂 API**: 内置兼容 Gemini, 智谱 (GLM), OpenAI, Anthropic (Claude), DeepSeek, Moonshot, X.AI, 阿里云 (Qwen), 火山引擎 等。
  - **Ollama**: 本地离线模型支持。
  - **自定义节点**: 支持兼容 OpenAI 格式的第三方/自建 API 端点接入。
- **覆盖层浮窗**: 翻译结果显示在一个无边框、可拖动、可调节的浮窗上，不干扰游戏的原始画面。
- **缓存与防抖机制**: 内置 SQLite + 内存双层独立缓存（按游戏隔离）。同时支持防抖，适配玩家快进文本。

## 🎮 软件使用

1. **获取软件**:
   - 直接点击右侧的 **Releases** 页面下载最新版的 `RenpyLens.exe`。
   - 或者也可以按照下方的 **[🛠️ 代码开发](#-代码开发)** 步骤，自行克隆代码并使用 Python 运行或打包。
2. **配置 API / 模型**: 
   - **无自有 API / 极简操作用户**: 直接双击 `.exe` 打开软件，在翻译引擎中选择 **"内置通道"**，点击 **"🔑 获取试用 API"**，成功后即可直接导入游戏体验。
   - **自带 API / 高阶用户**: 点击 **“⚙️ 设置”** 按钮。在 **“API 设置”** 选项卡中，填入 LLM 服务商密钥及相关配置（例如 Gemini 或 Ollama 的本地地址端口）。
3. **选择游戏**:
   - 将需要翻译的 Ren'Py 游戏的主程序 `.exe` 直接拖拽到软件界面的指定区域。
4. **注入并启动**:
   - 拖入后，点击 **"▶ 开始游戏"**，工具会自动将所需的脚本放入游戏的 `game/` 文件夹下。
   - 游戏启动后，翻译浮窗会自动弹出。当游戏中出现新对话时，浮窗会实时显示翻译结果。
5. **浮窗控制**:
   - **拖动位置**: 鼠标左键按住浮窗上的文字拖动即可自由调整翻译界面在游戏上的位置。
   - **更多设置**: 鼠标 **右击文字** 即可唤出快捷菜单，进行更多控制。
6. **清理与卸载**:
   - 游戏结束后，你可以点击 **"📤 卸载 Hook"** 将翻译脚本从游戏目录中安全移除，恢复游戏原貌。
   - 若遇到翻译卡死或缓存的文案需要修改，可点击 **"🧹 清除当前游戏缓存"** 重置。

## 🛠️ 代码开发

### 环境要求
- Windows 操作系统 (推荐)
- Python 3.10+

### 克隆与安装

```bash
git clone https://github.com/your-username/RenpyTranslator.git
cd RenpyTranslator

# 使用虚拟环境 (推荐)
python -m venv venv
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 运行应用

```bash
python main.py
```

## 📦 打包可执行文件

使用附带的打包脚本可以一键打包成单文件 `.exe`。

```bash
# 需确保环境中已安装 pyinstaller
python build.py

# 如果需要使用特定的 Python 环境进行打包，可使用 --python 参数：
python build.py --python "C:\path\to\your\venv\python.exe"
```
打包成功后，独立的可执行文件为 `RenpyLens.exe`。
> **注意**: 该脚本会自动利用 `upx.exe`（如果存在同级目录）进行体积压缩。

## 🧩 架构简介

- **`main.py` & `settings_dialog.py`**: 基于 PyQt5 的核心 UI 与事件流。
- **`injector.py`**: 负责识别 Ren'Py 游戏并安全注入改写的 `_translator_hook.rpy`。
- **`translator.py`**: 多并发、具有池化思想的 LLM 翻译引擎网络请求封装。
- **`hook_server.py`**: 本地 TCP 服务端，负责与注入到游戏内部的 Hook 脚本进行极低延迟的双向通讯。
- **`cache.py`**: 本地翻译记忆库（SQLite），提高相同对话的显示速度并降低 API 开销。
- **`_translator_hook.rpy`**: (Ren'Py 脚本层) 挂载于游戏的内部生命周期，实现在每一句台词抛出屏幕前进行劫持、传递与等待。


## 📄 许可证 (License)

本项目采用 [GPLv3 License](LICENSE) 许可协议开源。
